{"version":3,"sources":["wechat.js"],"names":[],"mappings":";;;AAGA;;AACA,IAAI,OAAO,QAAQ,MAAR,CAAX;AACA,IAAI,UAAU,QAAQ,UAAR,CAAd;AACA,IAAI,UAAU,QAAQ,SAAR,CAAkB,QAAQ,SAAR,CAAlB,CAAd,C;AACA,IAAI,SAAS,oCAAb;AACA,IAAI,MAAM;AACN,iBAAa,SAAS;AADhB,CAAV;AAGA,SAAS,MAAT,CAAgB,GAAhB,EAAqB;AACjB,QAAI,OAAO,IAAX;AACA,SAAK,KAAL,GAAa,IAAI,KAAjB;AACA,SAAK,SAAL,GAAiB,IAAI,SAArB;AACA,SAAK,cAAL,GAAsB,IAAI,cAA1B;AACA,SAAK,eAAL,GAAuB,IAAI,eAA3B;;AAEA,SAAK,cAAL,GACK,IADL,CACU,UAAS,IAAT,EAAc;AAChB,YAAI;AACA,mBAAO,KAAK,KAAL,CAAW,IAAX,CAAP;AACH,SAFD,CAGA,OAAM,CAAN,EAAS;AACL,mBAAO,KAAK,iBAAL,EAAP;AACH;;AAED,YAAI,KAAK,kBAAL,CAAwB,IAAxB,CAAJ,EAAkC;AAC9B,oBAAQ,OAAR,CAAgB,IAAhB;AACH,SAFD,MAEO;AACH,mBAAO,KAAK,iBAAL,EAAP;AACH;AACJ,KAdL,EAeK,IAfL,CAeU,UAAS,IAAT,EAAc;AAChB,aAAK,YAAL,GAAoB,KAAK,YAAzB;AACA,aAAK,UAAL,GAAkB,KAAK,UAAvB;AACA,aAAK,eAAL,CAAqB,IAArB;AACH,KAnBL;AAoBH;AACD,OAAO,SAAP,CAAiB,kBAAjB,GAAsC,UAAS,IAAT,EAAe;AACjD,QAAI,CAAC,IAAD,IAAS,CAAC,KAAK,UAAf,IAA6B,CAAC,KAAK,YAAvC,EAAqD;AACjD,eAAO,KAAP;AACH;AACD,QAAI,eAAe,KAAK,YAAxB;AACA,QAAI,aAAa,KAAK,UAAtB;AACA,QAAI,MAAO,IAAI,IAAJ,EAAD,CAAa,OAAb,EAAV;AACA,QAAI,MAAM,UAAV,EAAsB;AAClB,eAAO,IAAP;AACH,KAFD,MAEO;AACH,eAAO,KAAP;AACH;AACJ,CAZD;AAaA,OAAO,SAAP,CAAiB,iBAAjB,GAAqC,YAAW;AAC5C,QAAI,MAAM,IAAI,WAAJ,CAAgB,OAAhB,CAAwB,OAAxB,EAAiC,KAAK,KAAtC,EAA6C,OAA7C,CAAqD,WAArD,EAAkE,KAAK,SAAvE,CAAV;AACA,WAAO,IAAI,OAAJ,CAAY,UAAS,OAAT,EAAkB,MAAlB,EAA0B;AACzC,gBAAQ,EAAC,KAAK,GAAN,EAAW,MAAM,IAAjB,EAAR,EAAgC,IAAhC,CAAqC,UAAS,QAAT,EAAkB;AACnD,oBAAQ,GAAR,CAAY,SAAS,IAArB;AACA,gBAAI,OAAO,SAAS,IAApB;AACA,gBAAI,MAAM,IAAI,IAAJ,GAAW,OAAX,EAAV;AACA,gBAAI,aAAa,MAAM,KAAK,UAAX,GAAwB,KAAG,IAA5C;AACA,iBAAK,UAAL,GAAkB,UAAlB;AACA,oBAAQ,IAAR;AACH,SAPD;AAQH,KATM,CAAP;AAUH,CAZD;;AAcA,OAAO,OAAP,GAAiB,MAAjB","file":"wechat-compiled.js","sourcesContent":["/**\r\n * Created by Administrator on 2016/12/18.\r\n */\r\n'use strict'\r\nvar sha1 = require('sha1');\r\nvar Promise = require('bluebird');\r\nvar request = Promise.promisify(require('request')); //request promise��\r\nvar prefix = \"https://api.weixin.qq.com/cgi-bin/\"\r\nvar api = {\r\n    accessToken: prefix + 'token?grant_type=client_credential&appid=APPID&secret=APPSECRET'\r\n}\r\nfunction Wechat(ops) {\r\n    var that = this;\r\n    this.appID = ops.APPID;\r\n    this.appSecret = ops.appSecret;\r\n    this.getAccessToken = ops.getAccessToken;\r\n    this.saveAccessToken = ops.saveAccessToken;\r\n\r\n    this.getAccessToken()\r\n        .then(function(data){\r\n            try {\r\n                data = JSON.parse(data)\r\n            }\r\n            catch(e) {\r\n                return that.updateAccessToken();\r\n            }\r\n\r\n            if (that.isValidAccessToken(data)){\r\n                Promise.resolve(data);\r\n            } else {\r\n                return that.updateAccessToken();\r\n            }\r\n        })\r\n        .then(function(data){\r\n            that.access_token = data.access_token;\r\n            that.expires_in = data.expires_in;\r\n            that.saveAccessToken(data);\r\n        })\r\n}\r\nWechat.prototype.isValidAccessToken = function(data) {\r\n    if (!data || !data.expires_in || !data.access_token) {\r\n        return false;\r\n    }\r\n    var access_token = data.access_token;\r\n    var expires_in = data.expires_in;\r\n    var now = (new Date()).getTime();\r\n    if (now < expires_in) {\r\n        return true;\r\n    } else {\r\n        return false;\r\n    }\r\n}\r\nWechat.prototype.updateAccessToken = function() {\r\n    var url = api.accessToken.replace('APPID', this.appID).replace('APPSECRET', this.appSecret);\r\n    return new Promise(function(resolve, reject) {\r\n        request({url: url, json: true}).then(function(response){\r\n            console.log(response.body);\r\n            var data = response.body;\r\n            var now = new Date().getTime();\r\n            var expires_in = now + data.expires_in - 20*1000;\r\n            data.expires_in = expires_in;\r\n            resolve(data);\r\n        })\r\n    })\r\n}\r\n\r\nmodule.exports = Wechat;"]}