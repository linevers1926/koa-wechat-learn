{"version":3,"sources":["delayed_stream.js"],"names":[],"mappings":"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","file":"delayed_stream-compiled.js","sourcesContent":["var Stream = require('stream').Stream;\nvar util = require('util');\n\nmodule.exports = DelayedStream;\nfunction DelayedStream() {\n  this.source = null;\n  this.dataSize = 0;\n  this.maxDataSize = 1024 * 1024;\n  this.pauseStream = true;\n\n  this._maxDataSizeExceeded = false;\n  this._released = false;\n  this._bufferedEvents = [];\n}\nutil.inherits(DelayedStream, Stream);\n\nDelayedStream.create = function(source, options) {\n  var delayedStream = new this();\n\n  options = options || {};\n  for (var option in options) {\n    delayedStream[option] = options[option];\n  }\n\n  delayedStream.source = source;\n\n  var realEmit = source.emit;\n  source.emit = function() {\n    delayedStream._handleEmit(arguments);\n    return realEmit.apply(source, arguments);\n  };\n\n  source.on('error', function() {});\n  if (delayedStream.pauseStream) {\n    source.pause();\n  }\n\n  return delayedStream;\n};\n\nObject.defineProperty(DelayedStream.prototype, 'readable', {\n  configurable: true,\n  enumerable: true,\n  get: function() {\n    return this.source.readable;\n  }\n});\n\nDelayedStream.prototype.setEncoding = function() {\n  return this.source.setEncoding.apply(this.source, arguments);\n};\n\nDelayedStream.prototype.resume = function() {\n  if (!this._released) {\n    this.release();\n  }\n\n  this.source.resume();\n};\n\nDelayedStream.prototype.pause = function() {\n  this.source.pause();\n};\n\nDelayedStream.prototype.release = function() {\n  this._released = true;\n\n  this._bufferedEvents.forEach(function(args) {\n    this.emit.apply(this, args);\n  }.bind(this));\n  this._bufferedEvents = [];\n};\n\nDelayedStream.prototype.pipe = function() {\n  var r = Stream.prototype.pipe.apply(this, arguments);\n  this.resume();\n  return r;\n};\n\nDelayedStream.prototype._handleEmit = function(args) {\n  if (this._released) {\n    this.emit.apply(this, args);\n    return;\n  }\n\n  if (args[0] === 'data') {\n    this.dataSize += args[1].length;\n    this._checkIfMaxDataSizeExceeded();\n  }\n\n  this._bufferedEvents.push(args);\n};\n\nDelayedStream.prototype._checkIfMaxDataSizeExceeded = function() {\n  if (this._maxDataSizeExceeded) {\n    return;\n  }\n\n  if (this.dataSize <= this.maxDataSize) {\n    return;\n  }\n\n  this._maxDataSizeExceeded = true;\n  var message =\n    'DelayedStream#maxDataSize of ' + this.maxDataSize + ' bytes exceeded.'\n  this.emit('error', new Error(message));\n};\n"]}