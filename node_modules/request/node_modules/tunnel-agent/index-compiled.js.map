{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index-compiled.js","sourcesContent":["'use strict'\n\nvar net = require('net')\n  , tls = require('tls')\n  , http = require('http')\n  , https = require('https')\n  , events = require('events')\n  , assert = require('assert')\n  , util = require('util')\n  ;\n\nexports.httpOverHttp = httpOverHttp\nexports.httpsOverHttp = httpsOverHttp\nexports.httpOverHttps = httpOverHttps\nexports.httpsOverHttps = httpsOverHttps\n\n\nfunction httpOverHttp(options) {\n  var agent = new TunnelingAgent(options)\n  agent.request = http.request\n  return agent\n}\n\nfunction httpsOverHttp(options) {\n  var agent = new TunnelingAgent(options)\n  agent.request = http.request\n  agent.createSocket = createSecureSocket\n  agent.defaultPort = 443\n  return agent\n}\n\nfunction httpOverHttps(options) {\n  var agent = new TunnelingAgent(options)\n  agent.request = https.request\n  return agent\n}\n\nfunction httpsOverHttps(options) {\n  var agent = new TunnelingAgent(options)\n  agent.request = https.request\n  agent.createSocket = createSecureSocket\n  agent.defaultPort = 443\n  return agent\n}\n\n\nfunction TunnelingAgent(options) {\n  var self = this\n  self.options = options || {}\n  self.proxyOptions = self.options.proxy || {}\n  self.maxSockets = self.options.maxSockets || http.Agent.defaultMaxSockets\n  self.requests = []\n  self.sockets = []\n\n  self.on('free', function onFree(socket, host, port) {\n    for (var i = 0, len = self.requests.length; i < len; ++i) {\n      var pending = self.requests[i]\n      if (pending.host === host && pending.port === port) {\n        // Detect the request to connect same origin server,\n        // reuse the connection.\n        self.requests.splice(i, 1)\n        pending.request.onSocket(socket)\n        return\n      }\n    }\n    socket.destroy()\n    self.removeSocket(socket)\n  })\n}\nutil.inherits(TunnelingAgent, events.EventEmitter)\n\nTunnelingAgent.prototype.addRequest = function addRequest(req, options) {\n  var self = this\n\n   // Legacy API: addRequest(req, host, port, path)\n  if (typeof options === 'string') {\n    options = {\n      host: options,\n      port: arguments[2],\n      path: arguments[3]\n    };\n  }\n\n  if (self.sockets.length >= this.maxSockets) {\n    // We are over limit so we'll add it to the queue.\n    self.requests.push({host: options.host, port: options.port, request: req})\n    return\n  }\n\n  // If we are under maxSockets create a new one.\n  self.createConnection({host: options.host, port: options.port, request: req})\n}\n\nTunnelingAgent.prototype.createConnection = function createConnection(pending) {\n  var self = this\n\n  self.createSocket(pending, function(socket) {\n    socket.on('free', onFree)\n    socket.on('close', onCloseOrRemove)\n    socket.on('agentRemove', onCloseOrRemove)\n    pending.request.onSocket(socket)\n\n    function onFree() {\n      self.emit('free', socket, pending.host, pending.port)\n    }\n\n    function onCloseOrRemove(err) {\n      self.removeSocket(socket)\n      socket.removeListener('free', onFree)\n      socket.removeListener('close', onCloseOrRemove)\n      socket.removeListener('agentRemove', onCloseOrRemove)\n    }\n  })\n}\n\nTunnelingAgent.prototype.createSocket = function createSocket(options, cb) {\n  var self = this\n  var placeholder = {}\n  self.sockets.push(placeholder)\n\n  var connectOptions = mergeOptions({}, self.proxyOptions, \n    { method: 'CONNECT'\n    , path: options.host + ':' + options.port\n    , agent: false\n    }\n  )\n  if (connectOptions.proxyAuth) {\n    connectOptions.headers = connectOptions.headers || {}\n    connectOptions.headers['Proxy-Authorization'] = 'Basic ' +\n        new Buffer(connectOptions.proxyAuth).toString('base64')\n  }\n\n  debug('making CONNECT request')\n  var connectReq = self.request(connectOptions)\n  connectReq.useChunkedEncodingByDefault = false // for v0.6\n  connectReq.once('response', onResponse) // for v0.6\n  connectReq.once('upgrade', onUpgrade)   // for v0.6\n  connectReq.once('connect', onConnect)   // for v0.7 or later\n  connectReq.once('error', onError)\n  connectReq.end()\n\n  function onResponse(res) {\n    // Very hacky. This is necessary to avoid http-parser leaks.\n    res.upgrade = true\n  }\n\n  function onUpgrade(res, socket, head) {\n    // Hacky.\n    process.nextTick(function() {\n      onConnect(res, socket, head)\n    })\n  }\n\n  function onConnect(res, socket, head) {\n    connectReq.removeAllListeners()\n    socket.removeAllListeners()\n\n    if (res.statusCode === 200) {\n      assert.equal(head.length, 0)\n      debug('tunneling connection has established')\n      self.sockets[self.sockets.indexOf(placeholder)] = socket\n      cb(socket)\n    } else {\n      debug('tunneling socket could not be established, statusCode=%d', res.statusCode)\n      var error = new Error('tunneling socket could not be established, ' + 'statusCode=' + res.statusCode)\n      error.code = 'ECONNRESET'\n      options.request.emit('error', error)\n      self.removeSocket(placeholder)\n    }\n  }\n\n  function onError(cause) {\n    connectReq.removeAllListeners()\n\n    debug('tunneling socket could not be established, cause=%s\\n', cause.message, cause.stack)\n    var error = new Error('tunneling socket could not be established, ' + 'cause=' + cause.message)\n    error.code = 'ECONNRESET'\n    options.request.emit('error', error)\n    self.removeSocket(placeholder)\n  }\n}\n\nTunnelingAgent.prototype.removeSocket = function removeSocket(socket) {\n  var pos = this.sockets.indexOf(socket)\n  if (pos === -1) return\n  \n  this.sockets.splice(pos, 1)\n\n  var pending = this.requests.shift()\n  if (pending) {\n    // If we have pending requests and a socket gets closed a new one\n    // needs to be created to take over in the pool for the one that closed.\n    this.createConnection(pending)\n  }\n}\n\nfunction createSecureSocket(options, cb) {\n  var self = this\n  TunnelingAgent.prototype.createSocket.call(self, options, function(socket) {\n    // 0 is dummy port for v0.6\n    var secureSocket = tls.connect(0, mergeOptions({}, self.options, \n      { servername: options.host\n      , socket: socket\n      }\n    ))\n    self.sockets[self.sockets.indexOf(socket)] = secureSocket\n    cb(secureSocket)\n  })\n}\n\n\nfunction mergeOptions(target) {\n  for (var i = 1, len = arguments.length; i < len; ++i) {\n    var overrides = arguments[i]\n    if (typeof overrides === 'object') {\n      var keys = Object.keys(overrides)\n      for (var j = 0, keyLen = keys.length; j < keyLen; ++j) {\n        var k = keys[j]\n        if (overrides[k] !== undefined) {\n          target[k] = overrides[k]\n        }\n      }\n    }\n  }\n  return target\n}\n\n\nvar debug\nif (process.env.NODE_DEBUG && /\\btunnel\\b/.test(process.env.NODE_DEBUG)) {\n  debug = function() {\n    var args = Array.prototype.slice.call(arguments)\n    if (typeof args[0] === 'string') {\n      args[0] = 'TUNNEL: ' + args[0]\n    } else {\n      args.unshift('TUNNEL:')\n    }\n    console.error.apply(console, args)\n  }\n} else {\n  debug = function() {}\n}\nexports.debug = debug // for test\n"]}